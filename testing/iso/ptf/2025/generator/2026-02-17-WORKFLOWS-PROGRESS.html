<!DOCTYPE html>
<html lang="en" data-color-mode="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Generator Workflows — Performance and Correctness Investigation</title>
<style>
.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;margin:0;color:#1f2328;background-color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:' ';display:inline-block;background-color:currentColor;-webkit-mask-image:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg>");mask-image:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg>")}.markdown-body details,.markdown-body figcaption,.markdown-body figure{display:block}.markdown-body summary{display:list-item}.markdown-body [hidden]{display:none!important}.markdown-body a{background-color:transparent;color:#0969da;text-decoration:none}.markdown-body abbr[title]{border-bottom:none;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}.markdown-body b,.markdown-body strong{font-weight:600}.markdown-body dfn{font-style:italic}.markdown-body h1{margin:.67em 0;font-weight:600;padding-bottom:.3em;font-size:2em;border-bottom:1px solid #d7dde3}.markdown-body mark{background-color:#fff8c5;color:#1f2328}.markdown-body small{font-size:90%}.markdown-body sub,.markdown-body sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}.markdown-body sub{bottom:-.25em}.markdown-body sup{top:-.5em}.markdown-body img{border-style:none;max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body code,.markdown-body kbd,.markdown-body pre,.markdown-body samp{font-family:monospace;font-size:1em}.markdown-body figure{margin:1em 40px}.markdown-body hr{box-sizing:content-box;overflow:hidden;background:0 0;border-bottom:1px solid #d7dde3;height:.25em;padding:0;margin:24px 0;background-color:#d0d7de;border:0}.markdown-body input{font:inherit;margin:0;overflow:visible;font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body [type=button],.markdown-body [type=reset],.markdown-body [type=submit]{-webkit-appearance:button;appearance:button}.markdown-body [type=checkbox],.markdown-body [type=radio]{box-sizing:border-box;padding:0}.markdown-body [type=number]::-webkit-inner-spin-button,.markdown-body [type=number]::-webkit-outer-spin-button{height:auto}.markdown-body [type=search]::-webkit-search-cancel-button,.markdown-body [type=search]::-webkit-search-decoration{-webkit-appearance:none;appearance:none}.markdown-body ::-webkit-input-placeholder{color:inherit;opacity:.54}.markdown-body ::-webkit-file-upload-button{-webkit-appearance:button;appearance:button;font:inherit}.markdown-body a:hover{text-decoration:underline}.markdown-body ::placeholder{color:#6e7781;opacity:1}.markdown-body hr::before{display:table;content:""}.markdown-body hr::after{display:table;clear:both;content:""}.markdown-body table{border-spacing:0;border-collapse:collapse;display:block;width:max-content;max-width:100%;overflow:auto}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body details:not([open])>:not(summary){display:none!important}.markdown-body [role=button]:focus,.markdown-body a:focus,.markdown-body input[type=checkbox]:focus,.markdown-body input[type=radio]:focus{outline:2px solid #0969da;outline-offset:-2px;box-shadow:none}.markdown-body [role=button]:focus:not(:focus-visible),.markdown-body a:focus:not(:focus-visible),.markdown-body input[type=checkbox]:focus:not(:focus-visible),.markdown-body input[type=radio]:focus:not(:focus-visible){outline:solid 1px transparent}.markdown-body [role=button]:focus-visible,.markdown-body a:focus-visible,.markdown-body input[type=checkbox]:focus-visible,.markdown-body input[type=radio]:focus-visible{outline:2px solid #0969da;outline-offset:-2px;box-shadow:none}.markdown-body a:not([class]):focus,.markdown-body a:not([class]):focus-visible,.markdown-body input[type=checkbox]:focus,.markdown-body input[type=checkbox]:focus-visible,.markdown-body input[type=radio]:focus,.markdown-body input[type=radio]:focus-visible{outline-offset:0}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;line-height:10px;color:#1f2328;vertical-align:middle;background-color:#f6f8fa;border:solid 1px rgba(175,184,193,.2);border-bottom-color:rgba(175,184,193,.2);border-radius:6px;box-shadow:inset 0 -1px 0 rgba(175,184,193,.2)}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h2{font-weight:600;padding-bottom:.3em;font-size:1.5em;border-bottom:1px solid #d7dde3}.markdown-body h3{font-weight:600;font-size:1.25em}.markdown-body h4{font-weight:600;font-size:1em}.markdown-body h5{font-weight:600;font-size:.875em}.markdown-body h6{font-weight:600;font-size:.85em;color:#656d76}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0;padding:0 1em;color:#656d76;border-left:.25em solid #d0d7de}.markdown-body ol,.markdown-body ul{margin-top:0;margin-bottom:0;padding-left:2em}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body samp,.markdown-body tt{font-family:ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0;font-family:ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;font-size:12px;word-wrap:normal}.markdown-body .octicon{display:inline-block;overflow:visible!important;vertical-align:text-bottom;fill:currentColor}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body .mr-2{margin-right:8px!important}.markdown-body::before{display:table;content:""}.markdown-body::after{display:table;clear:both;content:""}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body .absent{color:#d1242f}.markdown-body .anchor{float:left;padding-right:4px;margin-left:-20px;line-height:1}.markdown-body .anchor:focus{outline:0}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1f2328;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1 code,.markdown-body h1 tt,.markdown-body h2 code,.markdown-body h2 tt,.markdown-body h3 code,.markdown-body h3 tt,.markdown-body h4 code,.markdown-body h4 tt,.markdown-body h5 code,.markdown-body h5 tt,.markdown-body h6 code,.markdown-body h6 tt{padding:0 .2em;font-size:inherit}.markdown-body summary h1,.markdown-body summary h2,.markdown-body summary h3,.markdown-body summary h4,.markdown-body summary h5,.markdown-body summary h6{display:inline-block}.markdown-body summary h1 .anchor,.markdown-body summary h2 .anchor,.markdown-body summary h3 .anchor,.markdown-body summary h4 .anchor,.markdown-body summary h5 .anchor,.markdown-body summary h6 .anchor{margin-left:-40px}.markdown-body summary h1,.markdown-body summary h2{padding-bottom:0;border-bottom:0}.markdown-body ol.no-list,.markdown-body ul.no-list{padding:0;list-style-type:none}.markdown-body ol[type="a s"]{list-style-type:lower-alpha}.markdown-body ol[type="A s"]{list-style-type:upper-alpha}.markdown-body ol[type="i s"]{list-style-type:lower-roman}.markdown-body ol[type="I s"]{list-style-type:upper-roman}.markdown-body ol[type="1"]{list-style-type:decimal}.markdown-body div>ol:not([type]){list-style-type:decimal}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #d0d7de}.markdown-body table td>:last-child{margin-bottom:0}.markdown-body table tr{background-color:#fff;border-top:1px solid #d7dde3}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body table img{background-color:transparent}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body .emoji{max-width:none;vertical-align:text-top;background-color:transparent}.markdown-body span.frame{display:block;overflow:hidden}.markdown-body span.frame>span{display:block;float:left;width:auto;padding:7px;margin:13px 0 0;overflow:hidden;border:1px solid #d0d7de}.markdown-body span.frame span img{display:block;float:left}.markdown-body span.frame span span{display:block;padding:5px 0 0;clear:both;color:#1f2328}.markdown-body span.align-center{display:block;overflow:hidden;clear:both}.markdown-body span.align-center>span{display:block;margin:13px auto 0;overflow:hidden;text-align:center}.markdown-body span.align-center span img{margin:0 auto;text-align:center}.markdown-body span.align-right{display:block;overflow:hidden;clear:both}.markdown-body span.align-right>span{display:block;margin:13px 0 0;overflow:hidden;text-align:right}.markdown-body span.align-right span img{margin:0;text-align:right}.markdown-body span.float-left{display:block;float:left;margin-right:13px;overflow:hidden}.markdown-body span.float-left span{margin:13px 0 0}.markdown-body span.float-right{display:block;float:right;margin-left:13px;overflow:hidden}.markdown-body span.float-right>span{display:block;margin:13px auto 0;overflow:hidden;text-align:right}.markdown-body code,.markdown-body tt{padding:.2em .4em;margin:0;font-size:85%;white-space:break-spaces;background-color:rgba(175,184,193,.2);border-radius:6px}.markdown-body code br,.markdown-body tt br{display:none}.markdown-body del code{text-decoration:inherit}.markdown-body samp{font-size:85%}.markdown-body pre code{font-size:100%}.markdown-body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;color:#1f2328;background-color:#f6f8fa;border-radius:6px}.markdown-body pre code,.markdown-body pre tt{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body .csv-data td,.markdown-body .csv-data th{padding:5px;overflow:hidden;font-size:12px;line-height:1;text-align:left;white-space:nowrap}.markdown-body .csv-data .blob-num{padding:10px 8px 9px;text-align:right;background:#fff;border:0}.markdown-body .csv-data tr{border-top:0}.markdown-body .csv-data th{font-weight:600;background:#f6f8fa;border-top:0}.markdown-body [data-footnote-ref]::before{content:"["}.markdown-body [data-footnote-ref]::after{content:"]"}.markdown-body .footnotes{font-size:12px;color:#656d76;border-top:1px solid #d0d7de}.markdown-body .footnotes ol{padding-left:16px}.markdown-body .footnotes ol ul{display:inline-block;padding-left:16px;margin-top:16px}.markdown-body .footnotes li{position:relative}.markdown-body .footnotes li:target::before{position:absolute;top:-8px;right:-8px;bottom:-8px;left:-24px;pointer-events:none;content:"";border:2px solid #0969da;border-radius:6px}.markdown-body .footnotes li:target{color:#1f2328}.markdown-body .footnotes .data-footnote-backref g-emoji{font-family:monospace}.markdown-body .pl-c{color:#57606a}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#0550ae}.markdown-body .pl-e,.markdown-body .pl-en{color:#6639ba}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292f}.markdown-body .pl-ent{color:#116329}.markdown-body .pl-k{color:#cf222e}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#0a3069}.markdown-body .pl-smw,.markdown-body .pl-v{color:#953800}.markdown-body .pl-bu{color:#82071e}.markdown-body .pl-ii{color:#f6f8fa;background-color:#82071e}.markdown-body .pl-c2{color:#f6f8fa;background-color:#cf222e}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#116329}.markdown-body .pl-ml{color:#3b2300}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#0550ae}.markdown-body .pl-mi{font-style:italic;color:#24292f}.markdown-body .pl-mb{font-weight:700;color:#24292f}.markdown-body .pl-md{color:#82071e;background-color:#ffebe9}.markdown-body .pl-mi1{color:#116329;background-color:#dafbe1}.markdown-body .pl-mc{color:#953800;background-color:#ffd8b5}.markdown-body .pl-mi2{color:#eaeef2;background-color:#0550ae}.markdown-body .pl-mdr{font-weight:700;color:#8250df}.markdown-body .pl-ba{color:#57606a}.markdown-body .pl-sg{color:#8c959f}.markdown-body .pl-corl{text-decoration:underline;color:#0a3069}.markdown-body g-emoji{display:inline-block;min-width:1ch;font-family:"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";font-size:1em;font-style:normal!important;font-weight:400;line-height:1;vertical-align:-.075em}.markdown-body g-emoji img{width:1em;height:1em}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item label{font-weight:400}.markdown-body .task-list-item.enabled label{cursor:pointer}.markdown-body .task-list-item+.task-list-item{margin-top:4px}.markdown-body .task-list-item .handle{display:none}.markdown-body .task-list-item-checkbox{margin:0 .2em .25em -1.4em;vertical-align:middle}.markdown-body .contains-task-list:dir(rtl) .task-list-item-checkbox{margin:0 -1.6em .25em .2em}.markdown-body .contains-task-list{position:relative}.markdown-body .contains-task-list:focus-within .task-list-item-convert-container,.markdown-body .contains-task-list:hover .task-list-item-convert-container{display:block;width:auto;height:24px;overflow:visible;clip:auto}.markdown-body ::-webkit-calendar-picker-indicator{filter:invert(50%)}.markdown-body .markdown-alert{padding:8px 16px;margin-bottom:16px;color:inherit;border-left:.25em solid #d0d7de}.markdown-body .markdown-alert>:first-child{margin-top:0}.markdown-body .markdown-alert>:last-child{margin-bottom:0}.markdown-body .markdown-alert .markdown-alert-title{display:flex;font-weight:500;align-items:center;line-height:1}.markdown-body .markdown-alert.markdown-alert-note{border-left-color:#0969da}.markdown-body .markdown-alert.markdown-alert-note .markdown-alert-title{color:#0969da}.markdown-body .markdown-alert.markdown-alert-important{border-left-color:#8250df}.markdown-body .markdown-alert.markdown-alert-important .markdown-alert-title{color:#8250df}.markdown-body .markdown-alert.markdown-alert-warning{border-left-color:#9a6700}.markdown-body .markdown-alert.markdown-alert-warning .markdown-alert-title{color:#9a6700}.markdown-body .markdown-alert.markdown-alert-tip{border-left-color:#1f883d}.markdown-body .markdown-alert.markdown-alert-tip .markdown-alert-title{color:#1a7f37}.markdown-body .markdown-alert.markdown-alert-caution{border-left-color:#cf222e}.markdown-body .markdown-alert.markdown-alert-caution .markdown-alert-title{color:#d1242f}
</style>
<style>
/* Layout styles for markdown-body container */
.markdown-body {
	box-sizing: border-box;
	min-width: 200px;
	max-width: 980px;
	margin: 0 auto;
	padding: 45px;
}

@media (max-width: 767px) {
	.markdown-body {
		padding: 15px;
	}
}

</style>
<style>
/* Print optimization styles */
@media print {
	/* Avoid breaking headings from following content */
	h1, h2, h3, h4, h5, h6 {
		page-break-after: avoid;
		break-after: avoid-page;
	}

	/* Keep these elements together */
	table, figure, div.no-break, pre {
		page-break-inside: avoid;
		break-inside: avoid-page;
	}

	/* Don't orphan paragraphs before kept-together elements */
	p:has(+ table, + figure, + div.no-break, + pre) {
		page-break-after: avoid;
		break-after: avoid-page;
	}

	/* Ensure code blocks don't overflow */
	pre {
		white-space: pre-wrap;
		word-wrap: break-word;
	}
}

</style>
<style>
/* Mermaid diagram styling */
.mermaid svg {
	display: block;
	margin-left: auto;
	margin-right: auto;
	width: auto;
	max-width: 100%;
}

/* Style for pre blocks before mermaid upgrade */
pre.mermaid {
	background: transparent;
	border: none;
	padding: 0;
}

/* Server-side rendered mermaid container */
.mermaid-container {
	position: relative;
	display: block;
	margin: 1rem 0;
}

.mermaid-container .mermaid-diagram {
	display: block;
	margin-left: auto;
	margin-right: auto;
	width: auto;
	max-width: 100%;
}

/* Show source button - appears on hover */
.mermaid-show-source {
	position: absolute;
	top: 0.5rem;
	right: 0.5rem;
	padding: 0.25rem 0.5rem;
	font-size: 0.75rem;
	background: var(--bgColor-muted, rgba(175, 184, 193, 0.2));
	border: 1px solid var(--borderColor-default, rgba(31, 35, 40, 0.15));
	border-radius: 6px;
	cursor: pointer;
	opacity: 0;
	transition: opacity 0.2s ease-in-out;
	color: var(--fgColor-muted, #636c76);
}

.mermaid-container:hover .mermaid-show-source,
.mermaid-container:focus-within .mermaid-show-source {
	opacity: 1;
}

.mermaid-show-source:hover {
	background: var(--bgColor-accent-muted, rgba(9, 105, 218, 0.1));
	border-color: var(--borderColor-accent-emphasis, #0969da);
	color: var(--fgColor-accent, #0969da);
}

/* Mermaid source dialog (popover) */
dialog[popover].mermaid-source,
dialog#[id$="-source"] {
	position: fixed;
	top: 50%;
	left: 50%;
	transform: translate(-50%, -50%);
	max-width: 90vw;
	max-height: 80vh;
	width: 600px;
	padding: 0;
	border: 1px solid var(--borderColor-default, rgba(31, 35, 40, 0.15));
	border-radius: 12px;
	box-shadow: 0 8px 24px rgba(140, 149, 159, 0.2);
	background: var(--bgColor-default, #ffffff);
	overflow: hidden;
}

/* Dark mode support */
[data-color-mode="dark"] dialog[popover],
[data-color-mode="dark"] dialog#[id$="-source"] {
	background: var(--bgColor-default, #0d1117);
	border-color: var(--borderColor-default, #30363d);
	box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
}

.mermaid-source-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 0.75rem 1rem;
	background: var(--bgColor-muted, #f6f8fa);
	border-bottom: 1px solid var(--borderColor-default, rgba(31, 35, 40, 0.15));
	font-weight: 600;
}

[data-color-mode="dark"] .mermaid-source-header {
	background: var(--bgColor-muted, #161b22);
	border-bottom-color: var(--borderColor-default, #30363d);
}

.mermaid-source-header button {
	padding: 0.25rem 0.5rem;
	font-size: 0.75rem;
	background: transparent;
	border: 1px solid var(--borderColor-default, rgba(31, 35, 40, 0.15));
	border-radius: 6px;
	cursor: pointer;
	color: var(--fgColor-muted, #636c76);
}

.mermaid-source-header button:hover {
	background: var(--bgColor-danger-muted, rgba(248, 81, 73, 0.1));
	border-color: var(--borderColor-danger-emphasis, #cf222e);
	color: var(--fgColor-danger, #cf222e);
}

/* Dialog pre/code styling */
dialog[popover] pre,
dialog#[id$="-source"] pre {
	margin: 0;
	padding: 1rem;
	max-height: calc(80vh - 60px);
	overflow: auto;
	background: var(--bgColor-muted, #f6f8fa);
}

[data-color-mode="dark"] dialog[popover] pre,
[data-color-mode="dark"] dialog#[id$="-source"] pre {
	background: var(--bgColor-muted, #161b22);
}

dialog[popover] code,
dialog#[id$="-source"] code {
	font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
	font-size: 0.875rem;
	line-height: 1.5;
	white-space: pre-wrap;
	word-break: break-word;
}

/* Backdrop styling */
dialog[popover]::backdrop,
dialog#[id$="-source"]::backdrop {
	background: rgba(0, 0, 0, 0.4);
}

/* Print: hide interactive elements */
@media print {
	.mermaid-show-source {
		display: none;
	}

	dialog[popover],
	dialog#[id$="-source"] {
		display: none;
	}
}

</style>
</head>
<body>
<article class="markdown-body">
<h1 id="generator-workflows-performance-and-correctness-investigation">Generator Workflows — Performance and Correctness Investigation</h1>
<p><strong>Started:</strong> 2026-02-16<br>
<strong>Last Updated:</strong> 2026-02-17<br>
<strong>Status:</strong> Active Investigation</p>
<hr>
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#1-parallel-workers--root-cause-and-fix">Parallel Workers — Root Cause and Fix</a></li>
<li><a href="#2-content-stream-worker-dispatching--investigation">Content Stream Worker Dispatching — Investigation</a></li>
<li><a href="#3-pdf-object-cleanup--orphaned-objects">PDF Object Cleanup — Orphaned Objects</a></li>
<li><a href="#4-browser-test-matrix--crash-patterns">Browser Test Matrix — Crash Patterns</a></li>
<li><a href="#5-roadmap">Roadmap</a></li>
<li><a href="#6-activity-log">Activity Log</a></li>
</ol>
<hr>
<h2 id="1-parallel-workers-root-cause-and-fix">1. Parallel Workers — Root Cause and Fix</h2>
<h3 id="problem-statement">Problem Statement</h3>
<p>Parallel Workers with <code class="notranslate">workerCount: 6</code> show no significant improvement over <code class="notranslate">workerCount: 2</code>. Workers initialize successfully but generation time (~7+ minutes) is unchanged.</p>
<h3 id="root-cause">Root Cause</h3>
<p>Three compounding issues prevent effective worker utilization:</p>
<p><strong>Issue 1: Sequential Page Processing (Primary Bottleneck)</strong></p>
<p><code class="notranslate">classes/baseline/pdf-document-color-converter.js:412</code> processes pages in a strict sequential loop:</p>
<div class="highlight highlight-source-js"><pre class="notranslate"><span class="pl-k">for</span> <span class="pl-kos">(</span><span class="pl-k">let</span> <span class="pl-s1">pageIndex</span> <span class="pl-c1">=</span> <span class="pl-c1">0</span><span class="pl-kos">;</span> <span class="pl-s1">pageIndex</span> <span class="pl-c1">&lt;</span> <span class="pl-s1">allPages</span><span class="pl-kos">.</span><span class="pl-c1">length</span><span class="pl-kos">;</span> <span class="pl-s1">pageIndex</span><span class="pl-c1">++</span><span class="pl-kos">)</span> <span class="pl-kos">{</span>
    <span class="pl-k">if</span> <span class="pl-kos">(</span><span class="pl-s1">pageFilter</span> <span class="pl-c1">&amp;&amp;</span> <span class="pl-c1">!</span><span class="pl-s1">pageFilter</span><span class="pl-kos">.</span><span class="pl-en">has</span><span class="pl-kos">(</span><span class="pl-s1">pageIndex</span><span class="pl-kos">)</span><span class="pl-kos">)</span> <span class="pl-k">continue</span><span class="pl-kos">;</span>
    <span class="pl-k">const</span> <span class="pl-s1">pageConverter</span> <span class="pl-c1">=</span> <span class="pl-smi">this</span><span class="pl-kos">.</span><span class="pl-en">createChildConverter</span><span class="pl-kos">(</span><span class="pl-v">PDFPageColorConverter</span><span class="pl-kos">,</span> <span class="pl-s1">pageConfig</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-k">await</span> <span class="pl-s1">pageConverter</span><span class="pl-kos">.</span><span class="pl-en">ensureReady</span><span class="pl-kos">(</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-s1">result</span> <span class="pl-c1">=</span> <span class="pl-k">await</span> <span class="pl-s1">pageConverter</span><span class="pl-kos">.</span><span class="pl-en">convertColor</span><span class="pl-kos">(</span><span class="pl-kos">{</span>...<span class="pl-kos">}</span><span class="pl-kos">,</span> <span class="pl-s1">context</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-s1">pageConverter</span><span class="pl-kos">.</span><span class="pl-en">dispose</span><span class="pl-kos">(</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
<span class="pl-kos">}</span></pre></div>
<p>With 1-3 images per page and 6 workers, at most 3 workers are busy while the rest sit idle.</p>
<p><strong>Issue 2: Content Streams Always Main-Thread</strong></p>
<p><code class="notranslate">classes/baseline/pdf-page-color-converter.js:562-654</code> processes content streams sequentially on the main thread.</p>
<p><strong>Issue 3: Worker Feed Starvation</strong></p>
<p>Sequential pages + parallel-within-page creates "feast or famine" — workers busy for ~200ms then idle for ~550ms (content stream + inter-conversion delay).</p>
<h3 id="two-alternatives-evaluated">Two Alternatives Evaluated</h3>
<markdown-accessiblity-table><table role="table">
<thead>
<tr>
<th>Criterion</th>
<th>Alternative A (Cross-Page Dispatching)</th>
<th>Alternative B (Concurrent Subset Converters)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Changes to <code class="notranslate">classes/</code></td>
<td>2 files, ~140 lines</td>
<td>0 (B1) or 2 lines (B2)</td>
</tr>
<tr>
<td>Changes to <code class="notranslate">generator/</code></td>
<td>0</td>
<td>1 file, ~60 lines</td>
</tr>
<tr>
<td>Regression risk</td>
<td>High — core loop rewrite</td>
<td>Low — consumer-only change</td>
</tr>
<tr>
<td>Worker utilization</td>
<td>Maximum</td>
<td>High (3x page throughput)</td>
</tr>
<tr>
<td>Memory overhead</td>
<td>Minimal</td>
<td>+32 MB (B1) or minimal (B2)</td>
</tr>
<tr>
<td>Ecosystem impact</td>
<td>All consumers affected</td>
<td>Generator-only</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<h3 id="decision-b1-zero-changes-to-classes">Decision: B1 (Zero Changes to <code class="notranslate">classes/</code>)</h3>
<p><strong>Implemented</strong> in <code class="notranslate">generator/classes/asset-page-pre-converter.js</code>:</p>
<ul>
<li>Split each chain's pages into up to 3 concurrent subsets</li>
<li>Each subset runs its own <code class="notranslate">PDFDocumentColorConverter</code> sharing the same <code class="notranslate">WorkerPool</code></li>
<li><code class="notranslate">Promise.all</code> runs converters concurrently — workers receive tasks from multiple pages simultaneously</li>
<li>Falls back to single converter (identical to previous behavior) when workers disabled</li>
<li>Progress aggregation across concurrent converters via shared counter (safe — JS is single-threaded)</li>
<li>Helper: <code class="notranslate">splitIntoSubsets(array, n)</code> — round-robin distribution</li>
</ul>
<h3 id="upgrade-path-b2-shared-wasm-engine">Upgrade Path: B2 (Shared WASM Engine)</h3>
<p>If B1's ~32 MB extra memory (2 additional WASM engines) is problematic:</p>
<ul>
<li>1-line change to <code class="notranslate">classes/baseline/pdf-document-color-converter.js:161</code>: add <code class="notranslate">options = {}</code> parameter with <code class="notranslate">...options</code> spread to <code class="notranslate">super()</code> call</li>
<li>Enables <code class="notranslate">createChildConverter</code> pattern — all converters share a single WASM engine</li>
<li>Backward-compatible — existing callers unaffected</li>
</ul>
<hr>
<h2 id="2-content-stream-worker-dispatching-investigation">2. Content Stream Worker Dispatching — Investigation</h2>
<h3 id="context">Context</h3>
<p>A 213 MB content stream (Lab color chart, page 18) is processed on the main thread while all workers sit idle. Threshold idea: dispatch streams estimated above 50 MB uncompressed to workers.</p>
<h3 id="infrastructure-assessment">Infrastructure Assessment</h3>
<p>The worker infrastructure is <strong>~90% built</strong>:</p>
<markdown-accessiblity-table><table role="table">
<thead>
<tr>
<th>Component</th>
<th>File</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="notranslate">prepareWorkerTask()</code></td>
<td><code class="notranslate">pdf-content-stream-color-converter.js:886</code></td>
<td>Exists</td>
</tr>
<tr>
<td><code class="notranslate">applyWorkerResult()</code></td>
<td><code class="notranslate">pdf-content-stream-color-converter.js:917</code></td>
<td>Exists (expects <code class="notranslate">compressedResult</code>)</td>
</tr>
<tr>
<td><code class="notranslate">supportsWorkerMode</code></td>
<td><code class="notranslate">pdf-content-stream-color-converter.js:874</code></td>
<td>Returns <code class="notranslate">true</code></td>
</tr>
<tr>
<td><code class="notranslate">processContentStream()</code></td>
<td><code class="notranslate">worker-pool-entrypoint.js:323-400</code></td>
<td>Exists (returns <code class="notranslate">newText</code> string)</td>
</tr>
<tr>
<td><code class="notranslate">submitContentStream()</code></td>
<td><code class="notranslate">worker-pool.js:663</code></td>
<td>Exists</td>
</tr>
<tr>
<td>Size-based dispatch branch</td>
<td><code class="notranslate">pdf-page-color-converter.js:562-654</code></td>
<td><strong>Missing</strong> — always main-thread</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<h3 id="gap-return-format-mismatch">Gap: Return Format Mismatch</h3>
<p>Worker <code class="notranslate">processContentStream()</code> materializes result as <code class="notranslate">newText</code> (string, line 365-367). But <code class="notranslate">applyWorkerResult()</code> expects <code class="notranslate">compressedResult</code> (compressed Uint8Array). The worker must encode the rebuilt text to UTF-8 and compress it with FlateDecode before returning.</p>
<h3 id="changes-needed-55-lines-across-2-files-in-classes-baseline">Changes Needed (~55 lines across 2 files in <code class="notranslate">classes/baseline/</code>)</h3>
<ol>
<li><strong><code class="notranslate">worker-pool-entrypoint.js</code></strong>: In <code class="notranslate">processContentStream()</code>, compress rebuilt text to Uint8Array instead of returning string. Add <code class="notranslate">compressedResult</code> to <code class="notranslate">sendResult()</code> transferables.</li>
<li><strong><code class="notranslate">pdf-page-color-converter.js</code></strong>: Add size-based dispatch branch — estimate uncompressed size, if above threshold dispatch to worker pool, otherwise process on main thread.</li>
</ol>
<h3 id="not-yet-implemented-awaiting-decision">Not Yet Implemented — Awaiting Decision</h3>
<hr>
<h2 id="3-pdf-object-cleanup-orphaned-objects">3. PDF Object Cleanup — Orphaned Objects</h2>
<h3 id="problem-statement-1">Problem Statement</h3>
<p>Separate/recombined chain PDFs are drastically oversized:</p>
<markdown-accessiblity-table><table role="table">
<thead>
<tr>
<th>Chain</th>
<th>Pages</th>
<th>Size</th>
<th>Expected Proportion</th>
</tr>
</thead>
<tbody>
<tr>
<td>sRGB</td>
<td>8</td>
<td>1.84 GB</td>
<td>36% of 22 pages</td>
</tr>
<tr>
<td>sGray</td>
<td>10</td>
<td>892.8 MB</td>
<td>45% of 22 pages</td>
</tr>
<tr>
<td>SepK</td>
<td>2</td>
<td>1.5 GB</td>
<td>9% of 22 pages</td>
</tr>
<tr>
<td>Lab</td>
<td>2</td>
<td>1.5 GB</td>
<td>9% of 22 pages</td>
</tr>
<tr>
<td><strong>Sum</strong></td>
<td><strong>22</strong></td>
<td><strong>5.73 GB</strong></td>
<td>—</td>
</tr>
<tr>
<td>Recombined</td>
<td>22</td>
<td>2.14 GB</td>
<td>—</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p>The sum of chain PDFs (5.73 GB) is <strong>2.7x</strong> the recombined document (2.14 GB). The SepK chain (2 pages, passthrough — no conversion) is 1.5 GB.</p>
<h3 id="root-cause-removepage-does-not-remove-underlying-objects">Root Cause: <code class="notranslate">removePage</code> Does Not Remove Underlying Objects</h3>
<p><strong>The chain workflow</strong> (<code class="notranslate">test-form-pdf-document-generator.js</code>):</p>
<ol>
<li><strong>Line 660</strong>: Each chain loads the <strong>full</strong> asset PDF: <code class="notranslate">PDFDocument.load(assetPDFBuffer)</code> — all 22 pages' objects loaded into <code class="notranslate">PDFContext.indirectObjects</code></li>
<li><strong><code class="notranslate">#assemblePages</code> Phase A</strong>: Converts only this chain's pages (e.g., 8 for sRGB)</li>
<li><strong>Phase B</strong>: Creates layout pages using <code class="notranslate">embedPage()</code> + <code class="notranslate">drawPage()</code> — Form XObjects reference converted asset streams</li>
<li><strong>Phase C (line 549-551)</strong>: <code class="notranslate">removePage(i)</code> for all asset pages — removes from <strong>page tree only</strong></li>
<li><strong>Save (line 695)</strong>: <code class="notranslate">assembledDocument.save()</code> serializes <strong>ALL</strong> indirect objects, including orphaned ones</li>
</ol>
<p><strong>pdf-lib's <code class="notranslate">removePage</code></strong> (line 36908 of <code class="notranslate">pdf-lib.esm.js</code>) calls <code class="notranslate">this.catalog.removeLeafNode(index)</code> — it removes the page from the catalog's page tree but does <strong>NOT</strong> delete the page's underlying objects (image streams, ICC profiles, fonts, resource dictionaries) from <code class="notranslate">PDFContext.indirectObjects</code>.</p>
<p><strong>Consequence:</strong> The sRGB chain (8 pages) carries image streams from all 22 source pages. The 14 non-sRGB pages' resources are orphaned in the context but still serialized on save.</p>
<h3 id="existing-cleanup-methods-never-called">Existing Cleanup Methods (Never Called)</h3>
<p>Two cleanup methods exist in <code class="notranslate">services/PDFService.js</code> but are <strong>never called</strong> from any generator workflow:</p>
<p><strong><code class="notranslate">PDFService.removeOrphanedObjects(pdfDocument)</code></strong> (line 1725):</p>
<ul>
<li>Traverses from document roots (catalog, trailer info)</li>
<li>Recursively collects all reachable <code class="notranslate">PDFRef</code> objects</li>
<li>Identifies unreachable objects and deletes them from <code class="notranslate">context</code></li>
<li>Returns <code class="notranslate">{ removedCount, removedRefs }</code></li>
<li><strong>In-place</strong> — modifies the existing document</li>
</ul>
<p><strong><code class="notranslate">PDFService.repackPDFDocument(pdfDocument)</code></strong> (line 1691):</p>
<ul>
<li>Creates a new empty PDF</li>
<li>Copies all pages via <code class="notranslate">copyPages</code> (only referenced objects transfer)</li>
<li>Returns the new document</li>
<li><strong>Creates new document</strong> — higher memory but guaranteed clean</li>
</ul>
<h3 id="implementation">Implementation</h3>
<p><strong>Implemented</strong> in <code class="notranslate">test-form-pdf-document-generator.js</code> — both in-place and chain paths:</p>
<ol>
<li><code class="notranslate">await assembledDocument.flush()</code> — forces lazy <code class="notranslate">PDFEmbeddedPage</code> objects (from <code class="notranslate">embedPage()</code>) to finalize their Form XObjects, making asset page content streams truly orphaned</li>
<li><code class="notranslate">PDFService.removeOrphanedObjects(assembledDocument)</code> — deletes orphaned objects</li>
<li>Clear context's cached push/pop graphics state content stream refs (see Crash Fix below)</li>
</ol>
<h3 id="crash-fix-stale-push-pop-graphics-state-cache">Crash Fix: Stale Push/Pop Graphics State Cache</h3>
<p><strong>Symptom:</strong> <code class="notranslate">Expected instance of PDFStream, but got instance of undefined</code> at <code class="notranslate">PDFPageEmbedder.prototype.decodeContents</code> during <code class="notranslate">save()</code>.</p>
<p><strong>Root Cause:</strong> pdf-lib's <code class="notranslate">PDFContext</code> lazily creates and <strong>caches</strong> shared <code class="notranslate">q</code>/<code class="notranslate">Q</code> content streams (<code class="notranslate">pushGraphicsStateContentStreamRef</code>, <code class="notranslate">popGraphicsStateContentStreamRef</code>) at lines 16383-16408. During <code class="notranslate">flush()</code>, asset page embeds trigger <code class="notranslate">normalize()</code> which creates these streams and inserts their refs into asset pages' Contents arrays. Layout pages (created via <code class="notranslate">addPage()</code>) do NOT receive these refs — <code class="notranslate">normalize()</code> calls <code class="notranslate">wrapContentStreams()</code> but returns false because the new page has no existing Contents array.</p>
<p>After <code class="notranslate">removeOrphanedObjects()</code>, the push/pop streams are correctly identified as orphaned (only reachable from removed asset pages, not from layout pages in the page tree) and deleted from <code class="notranslate">indirectObjects</code>. But the context's cached refs still hold the stale values. When slug pages are later embedded during <code class="notranslate">save()</code> → <code class="notranslate">flush()</code>, <code class="notranslate">normalize()</code> on the copied slug page calls <code class="notranslate">getPushGraphicsStateContentStream()</code> which returns the <strong>stale cached ref</strong>, inserts it into the slug page's Contents array, and <code class="notranslate">decodeContents()</code> crashes trying to look up the deleted stream.</p>
<p><strong>Fix:</strong> Clear the cached refs after <code class="notranslate">removeOrphanedObjects()</code>:</p>
<div class="highlight highlight-source-js"><pre class="notranslate"><span class="pl-s1">assembledDocument</span><span class="pl-kos">.</span><span class="pl-c1">context</span><span class="pl-kos">.</span><span class="pl-c1">pushGraphicsStateContentStreamRef</span> <span class="pl-c1">=</span> <span class="pl-c1">undefined</span><span class="pl-kos">;</span>
<span class="pl-s1">assembledDocument</span><span class="pl-kos">.</span><span class="pl-c1">context</span><span class="pl-kos">.</span><span class="pl-c1">popGraphicsStateContentStreamRef</span> <span class="pl-c1">=</span> <span class="pl-c1">undefined</span><span class="pl-kos">;</span></pre></div>
<p>This causes <code class="notranslate">getPushGraphicsStateContentStream()</code> and <code class="notranslate">getPopGraphicsStateContentStream()</code> to create fresh streams when slug pages are later normalized during <code class="notranslate">save()</code> → <code class="notranslate">flush()</code>.</p>
<h3 id="impact-assessment">Impact Assessment</h3>
<ul>
<li><strong>Chain PDFs</strong>: Expected to shrink from ~1-1.8 GB per chain to proportional size (~100-400 MB each)</li>
<li><strong>Recombined PDF</strong>: Indirect improvement — smaller chain buffers mean less memory during recombination</li>
<li><strong>In-place PDF</strong>: Moderate improvement — removes replaced ICC profiles and pre-conversion resources</li>
<li><strong>Safety</strong>: <code class="notranslate">removeOrphanedObjects</code> traverses from document roots, so Form XObjects and their referenced streams are protected. Only truly unreachable objects are removed.</li>
<li><strong>Performance</strong>: The traversal adds time proportional to object count, but saves significant serialization time (fewer objects to write)</li>
</ul>
<h3 id="additional-concern-recombined-output-size">Additional Concern: Recombined Output Size</h3>
<p>The recombined PDF (2.14 GB) may also be larger than necessary. When <code class="notranslate">copyPages</code> brings chain pages into the target document, shared resources (fonts, ICC profiles) may be duplicated across chains. This is a separate issue from orphaned objects but contributes to final size.</p>
<hr>
<h2 id="4-browser-test-matrix-crash-patterns">4. Browser Test Matrix — Crash Patterns</h2>
<h3 id="test-results-r2-suffix-final-runs">Test Results (R2 Suffix — Final Runs)</h3>
<p>All tests used the full CR1 (F9e) Assets form. Files sorted chronologically by timestamp.</p>
<markdown-accessiblity-table><table role="table">
<thead>
<tr>
<th>#</th>
<th>Browser</th>
<th>Input BPC</th>
<th>Output BPC</th>
<th>Mode</th>
<th>Strategy</th>
<th>Thread</th>
<th>Workers</th>
<th>Result</th>
<th>Failure Point</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Safari</td>
<td>8-bit</td>
<td>16-bit</td>
<td>In-Place</td>
<td>—</td>
<td>Main</td>
<td>—</td>
<td>No download</td>
<td>Blob URL exceeds ~2 GB limit</td>
</tr>
<tr>
<td>2</td>
<td>Safari</td>
<td>8-bit</td>
<td>8-bit</td>
<td>In-Place</td>
<td>—</td>
<td>Bootstrap</td>
<td>4 workers</td>
<td>Crashed</td>
<td>Silent kill — Web Inspector memory overhead</td>
</tr>
<tr>
<td>3</td>
<td>Safari</td>
<td>8-bit</td>
<td>8-bit</td>
<td>In-Place</td>
<td>—</td>
<td>Bootstrap</td>
<td>6 workers</td>
<td>Crashed</td>
<td>Silent kill — Web Inspector memory overhead</td>
</tr>
<tr>
<td>4</td>
<td>Chrome</td>
<td>8-bit</td>
<td>8-bit</td>
<td>In-Place</td>
<td>—</td>
<td>Bootstrap</td>
<td>6 workers</td>
<td>Worked</td>
<td>&lt; 3 minutes</td>
</tr>
<tr>
<td>5</td>
<td>Chrome</td>
<td>16-bit</td>
<td>16-bit</td>
<td>In-Place</td>
<td>—</td>
<td>Bootstrap</td>
<td>2 workers</td>
<td>Crashed</td>
<td><code class="notranslate">RangeError: Array buffer allocation failed</code> in <code class="notranslate">PDFStreamWriter</code></td>
</tr>
<tr>
<td>6</td>
<td>Chrome</td>
<td>16-bit</td>
<td>16-bit</td>
<td>Recombined</td>
<td>—</td>
<td>Bootstrap</td>
<td>2 workers</td>
<td>Crashed</td>
<td><code class="notranslate">RangeError: Array buffer allocation failed</code> in <code class="notranslate">PDFParser.tryToParseInvalidIndirectObject</code></td>
</tr>
<tr>
<td>7</td>
<td>Safari</td>
<td>8-bit</td>
<td>16-bit</td>
<td>Recombined</td>
<td>Chains</td>
<td>Main</td>
<td>—</td>
<td>Worked</td>
<td>Completed but file too large to download</td>
</tr>
<tr>
<td>8</td>
<td>Safari (No Console)</td>
<td>8-bit</td>
<td>16-bit</td>
<td>Recombined</td>
<td>Chains</td>
<td>Main</td>
<td>—</td>
<td>Worked</td>
<td>22 pages, 4602ms recombination. Download succeeded.</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<h3 id="identified-failure-patterns">Identified Failure Patterns</h3>
<h4 id="pattern-1-safari-web-inspector-silent-process-kill">Pattern 1: Safari + Web Inspector = Silent Process Kill</h4>
<p><strong>Tests 2, 3</strong> — Safari with developer console open crashes during heavy processing.</p>
<ul>
<li><strong>Cause:</strong> Web Inspector adds significant memory overhead (~200-400 MB for instrumentation, breakpoint tracking, and console message buffering). Combined with the ~1.5-2 GB working set for full-form color conversion, total memory exceeds Safari's process limit.</li>
<li><strong>Evidence:</strong> Logs truncate mid-conversion with no error message. No exception, no stack trace — the web process is killed by the OS.</li>
<li><strong>Fix:</strong> Run production workloads with console closed, or use <code class="notranslate">"No Console"</code> Safari configuration.</li>
</ul>
<h4 id="pattern-2-chrome-16-bit-output-pdf-lib-serialization-crash">Pattern 2: Chrome 16-bit Output — pdf-lib Serialization Crash</h4>
<p><strong>Tests 5, 6</strong> — Chrome fails when producing 16-bit output PDFs.</p>
<ul>
<li><strong>Cause:</strong> pdf-lib's <code class="notranslate">PDFWriter</code>/<code class="notranslate">PDFStreamWriter</code> serializes the entire document into a single <code class="notranslate">ArrayBuffer</code>. A 22-page 16-bit PDF exceeds 2 GB, hitting V8's <code class="notranslate">ArrayBuffer</code> allocation limit.</li>
<li><strong>Evidence:</strong> <code class="notranslate">RangeError: Array buffer allocation failed</code> at <code class="notranslate">PDFStreamWriter</code> (In-Place) or <code class="notranslate">PDFParser.tryToParseInvalidIndirectObject</code> via <code class="notranslate">ByteStream.slice</code> (Recombined — failure during re-parsing chain buffers).</li>
<li><strong>Key insight:</strong> The crash is in pdf-lib's serialization, NOT in color conversion. All color conversion completes successfully.</li>
<li><strong>Fix:</strong> Requires either (a) streaming serialization in pdf-lib, (b) reducing output size via orphaned object cleanup, or (c) architectural changes to avoid materializing the entire PDF in memory.</li>
</ul>
<h4 id="pattern-3-safari-blob-url-size-limit">Pattern 3: Safari Blob URL Size Limit</h4>
<p><strong>Test 1, 7</strong> — Safari completes generation but the blob URL is too large to download.</p>
<ul>
<li><strong>Cause:</strong> Safari's <code class="notranslate">URL.createObjectURL()</code> or the download mechanism has a practical limit around ~2 GB for blob URLs.</li>
<li><strong>Evidence:</strong> PDF generates successfully, save completes, but the download link fails or produces a 0-byte file.</li>
<li><strong>Fix:</strong> For 16-bit output, use streaming download (e.g., <code class="notranslate">showSaveFilePicker</code> File System Access API) or chunk-based delivery.</li>
</ul>
<h4 id="pattern-4-16-bit-input-8-bit-output-works-fine">Pattern 4: 16-bit Input + 8-bit Output Works Fine</h4>
<p><strong>Test 4, 8</strong> — 8-bit output PDFs work across browsers.</p>
<ul>
<li><strong>Evidence:</strong> Chrome 8-bit in-place with 6 workers completed in under 3 minutes. Safari "No Console" 16-bit recombined completed and downloaded.</li>
<li><strong>Key insight:</strong> The output BPC (not input BPC) determines final PDF size. 8-bit output keeps the document under browser memory/download limits.</li>
</ul>
<h3 id="critical-takeaway">Critical Takeaway</h3>
<p><strong>Orphaned object cleanup (Section 3) directly addresses Patterns 2 and 3.</strong> If chain PDFs shrink from ~1.5 GB to ~200-400 MB each, the recombined 16-bit output may fit within the 2 GB limit. This should be tested before pursuing more complex solutions like streaming serialization.</p>
<hr>
<h2 id="5-roadmap">5. Roadmap</h2>
<h3 id="parallel-workers-b1">Parallel Workers (B1)</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Completed task" checked=""> Root cause investigation: identified sequential page loop as primary bottleneck</li>
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Completed task" checked=""> Document Alternative A (cross-page image dispatching) and Alternative B (concurrent page-subset converters)</li>
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Completed task" checked=""> Decide: B1 (zero changes to <code class="notranslate">classes/</code>) — <strong>selected</strong></li>
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Completed task" checked=""> Implement concurrent page-subset dispatching in <code class="notranslate">asset-page-pre-converter.js</code></li>
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Completed task" checked=""> Add progress aggregation across concurrent converters</li>
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Incomplete task"> Test with debugging enabled to verify worker utilization</li>
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Incomplete task"> Benchmark: compare wall time before/after</li>
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Incomplete task"> If B1 memory overhead is problematic, upgrade to B2 (1-line constructor change)</li>
</ul>
<h3 id="pdf-object-cleanup">PDF Object Cleanup</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Completed task" checked=""> Investigate chain PDF bloat — root cause identified (orphaned objects from <code class="notranslate">removePage</code>)</li>
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Completed task" checked=""> Confirm <code class="notranslate">PDFService.removeOrphanedObjects()</code> exists and is never called</li>
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Completed task" checked=""> Add <code class="notranslate">removeOrphanedObjects()</code> call after <code class="notranslate">#assemblePages</code> in chain workflow</li>
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Completed task" checked=""> Add <code class="notranslate">removeOrphanedObjects()</code> call after <code class="notranslate">#assemblePages</code> in in-place workflow</li>
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Completed task" checked=""> Fix crash: clear cached <code class="notranslate">pushGraphicsStateContentStreamRef</code>/<code class="notranslate">popGraphicsStateContentStreamRef</code> after orphan removal</li>
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Incomplete task"> Test: verify chain PDF sizes shrink to proportional values</li>
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Incomplete task"> Test: verify recombined 16-bit output fits within browser limits</li>
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Incomplete task"> Test: verify no visual regressions (Form XObjects properly preserved)</li>
</ul>
<h3 id="content-stream-worker-dispatching">Content Stream Worker Dispatching</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Completed task" checked=""> Investigation: infrastructure 90% built, gap identified (return format mismatch)</li>
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Incomplete task"> Decision: proceed with implementation (changes to 2 files in <code class="notranslate">classes/baseline/</code>)</li>
</ul>
<h3 id="browser-compatibility">Browser Compatibility</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Completed task" checked=""> Identify 4 failure patterns from test matrix</li>
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Incomplete task"> Verify orphaned object cleanup resolves Chrome 16-bit crash (Pattern 2)</li>
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox" aria-label="Incomplete task"> Investigate streaming download for Safari blob limit (Pattern 3)</li>
</ul>
<hr>
<h2 id="6-activity-log">6. Activity Log</h2>
<markdown-accessiblity-table><table role="table">
<thead>
<tr>
<th>Timestamp</th>
<th>Activity</th>
</tr>
</thead>
<tbody>
<tr>
<td>2026-02-16</td>
<td>Root cause investigation: identified sequential page loop as primary worker bottleneck</td>
</tr>
<tr>
<td>2026-02-16</td>
<td>Documented Alternative A (cross-page image dispatching) and Alternative B (concurrent page-subset converters)</td>
</tr>
<tr>
<td>2026-02-16</td>
<td>Memory and concurrency safety analysis complete</td>
</tr>
<tr>
<td>2026-02-17</td>
<td>Implemented B1: concurrent page-subset converters in <code class="notranslate">asset-page-pre-converter.js</code> (zero changes to <code class="notranslate">classes/</code>)</td>
</tr>
<tr>
<td>2026-02-17</td>
<td>Investigated content stream worker dispatching — infrastructure 90% built, gap: return format mismatch</td>
</tr>
<tr>
<td>2026-02-17</td>
<td>Analyzed browser test results (R2 runs): identified 4 failure patterns (Safari silent kill, Chrome pdf-lib crash, blob limit, output BPC)</td>
</tr>
<tr>
<td>2026-02-17</td>
<td>Investigated chain PDF bloat — root cause: <code class="notranslate">removePage</code> does not remove underlying objects from <code class="notranslate">PDFContext.indirectObjects</code></td>
</tr>
<tr>
<td>2026-02-17</td>
<td>Confirmed <code class="notranslate">PDFService.removeOrphanedObjects()</code> exists (line 1725) but is never called from any generator workflow</td>
</tr>
<tr>
<td>2026-02-17</td>
<td>Wired <code class="notranslate">flush()</code> + <code class="notranslate">removeOrphanedObjects()</code> into both in-place and chain paths in <code class="notranslate">test-form-pdf-document-generator.js</code></td>
</tr>
<tr>
<td>2026-02-17</td>
<td>Fixed crash: <code class="notranslate">removeOrphanedObjects()</code> deletes shared q/Q content streams cached on context; clear cache after removal</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
</article>


<script type="module">
function t(t){if("clipboard"in navigator)return navigator.clipboard.writeText(t.textContent||"");const e=getSelection();if(null==e)return Promise.reject(new Error);e.removeAllRanges();const i=document.createRange();return i.selectNodeContents(t),e.addRange(i),document.execCommand("copy"),e.removeAllRanges(),Promise.resolve()}function e(e){if("clipboard"in navigator)return navigator.clipboard.writeText(e);const i=document.body;if(!i)return Promise.reject(new Error);const s=function(t){const e=document.createElement("pre");return e.style.width="1px",e.style.height="1px",e.style.position="fixed",e.style.top="5px",e.textContent=t,e}(e);return i.appendChild(s),t(s),i.removeChild(s),Promise.resolve()}async function i(i){const s=i.getAttribute("for"),n=i.getAttribute("value");function r(){i.dispatchEvent(new CustomEvent("clipboard-copy",{bubbles:!0}))}var o;if("true"!==i.getAttribute("aria-disabled"))if(n)await e(n),r();else if(s){const n="getRootNode"in Element.prototype?i.getRootNode():i.ownerDocument;if(!(n instanceof Document||"ShadowRoot"in window&&n instanceof ShadowRoot))return;const a=n.getElementById(s);a&&(await(o=a,o instanceof HTMLInputElement||o instanceof HTMLTextAreaElement?e(o.value):o instanceof HTMLAnchorElement&&o.hasAttribute("href")?e(o.href):t(o)),r())}}function s(t){const e=t.currentTarget;e instanceof HTMLElement&&i(e)}function n(t){if(" "===t.key||"Enter"===t.key){const e=t.currentTarget;e instanceof HTMLElement&&(t.preventDefault(),i(e))}}function r(t){t.currentTarget.addEventListener("keydown",n)}function o(t){t.currentTarget.removeEventListener("keydown",n)}class a extends HTMLElement{static define(t="clipboard-copy",e=customElements){return e.define(t,this),this}constructor(){super(),this.addEventListener("click",s),this.addEventListener("focus",r),this.addEventListener("blur",o)}connectedCallback(){this.hasAttribute("tabindex")||this.setAttribute("tabindex","0"),this.hasAttribute("role")||this.setAttribute("role","button")}get value(){return this.getAttribute("value")||""}set value(t){this.setAttribute("value",t)}}const h="undefined"!=typeof globalThis?globalThis:window;try{h.ClipboardCopyElement=a.define()}catch(t){if(!(h.DOMException&&t instanceof DOMException&&"NotSupportedError"===t.name||t instanceof ReferenceError))throw t}var u,l=function(t,e,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(t):s?s.value:e.get(t)};const c="undefined"!=typeof Intl&&Intl.ListFormat||class{formatToParts(t){const e=[];for(const i of t)e.push({type:"element",value:i}),e.push({type:"literal",value:", "});return e.slice(0,-1)}},m=[["years","year"],["months","month"],["weeks","week"],["days","day"],["hours","hour"],["minutes","minute"],["seconds","second"],["milliseconds","millisecond"]],d={minimumIntegerDigits:2};class f{constructor(t,e={}){u.set(this,void 0);let i=String(e.style||"short");"long"!==i&&"short"!==i&&"narrow"!==i&&"digital"!==i&&(i="short");let s="digital"===i?"numeric":i;const n=e.hours||s;s="2-digit"===n?"numeric":n;const r=e.minutes||s;s="2-digit"===r?"numeric":r;const o=e.seconds||s;s="2-digit"===o?"numeric":o;const a=e.milliseconds||s;!function(t,e,i,s,n){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");"a"===s?n.call(t,i):n?n.value=i:e.set(t,i)}(this,u,{locale:t,style:i,years:e.years||"digital"===i?"short":i,yearsDisplay:"always"===e.yearsDisplay?"always":"auto",months:e.months||"digital"===i?"short":i,monthsDisplay:"always"===e.monthsDisplay?"always":"auto",weeks:e.weeks||"digital"===i?"short":i,weeksDisplay:"always"===e.weeksDisplay?"always":"auto",days:e.days||"digital"===i?"short":i,daysDisplay:"always"===e.daysDisplay?"always":"auto",hours:n,hoursDisplay:"always"===e.hoursDisplay||"digital"===i?"always":"auto",minutes:r,minutesDisplay:"always"===e.minutesDisplay||"digital"===i?"always":"auto",seconds:o,secondsDisplay:"always"===e.secondsDisplay||"digital"===i?"always":"auto",milliseconds:a,millisecondsDisplay:"always"===e.millisecondsDisplay?"always":"auto"},"f")}resolvedOptions(){return l(this,u,"f")}formatToParts(t){const e=[],i=l(this,u,"f"),s=i.style,n=i.locale;for(const[r,o]of m){const a=t[r];if("auto"===i[`${r}Display`]&&!a)continue;const h=i[r],u="2-digit"===h?d:"numeric"===h?{}:{style:"unit",unit:o,unitDisplay:h};let l=new Intl.NumberFormat(n,u).format(a);"months"===r&&("narrow"===h||"narrow"===s&&l.endsWith("m"))&&(l=l.replace(/(\d+)m$/,"$1mo")),e.push(l)}return new c(n,{type:"unit",style:"digital"===s?"short":s}).formatToParts(e)}format(t){return this.formatToParts(t).map(t=>t.value).join("")}}u=new WeakMap;const g=/^[-+]?P(?:(\d+)Y)?(?:(\d+)M)?(?:(\d+)W)?(?:(\d+)D)?(?:T(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?)?$/,w=["year","month","week","day","hour","minute","second","millisecond"];class y{constructor(t=0,e=0,i=0,s=0,n=0,r=0,o=0,a=0){this.years=t,this.months=e,this.weeks=i,this.days=s,this.hours=n,this.minutes=r,this.seconds=o,this.milliseconds=a,this.years||(this.years=0),this.sign||(this.sign=Math.sign(this.years)),this.months||(this.months=0),this.sign||(this.sign=Math.sign(this.months)),this.weeks||(this.weeks=0),this.sign||(this.sign=Math.sign(this.weeks)),this.days||(this.days=0),this.sign||(this.sign=Math.sign(this.days)),this.hours||(this.hours=0),this.sign||(this.sign=Math.sign(this.hours)),this.minutes||(this.minutes=0),this.sign||(this.sign=Math.sign(this.minutes)),this.seconds||(this.seconds=0),this.sign||(this.sign=Math.sign(this.seconds)),this.milliseconds||(this.milliseconds=0),this.sign||(this.sign=Math.sign(this.milliseconds)),this.blank=0===this.sign}abs(){return new y(Math.abs(this.years),Math.abs(this.months),Math.abs(this.weeks),Math.abs(this.days),Math.abs(this.hours),Math.abs(this.minutes),Math.abs(this.seconds),Math.abs(this.milliseconds))}static from(t){var e;if("string"==typeof t){const i=String(t).trim(),s=i.startsWith("-")?-1:1,n=null===(e=i.match(g))||void 0===e?void 0:e.slice(1).map(t=>(Number(t)||0)*s);return n?new y(...n):new y}if("object"==typeof t){const{years:e,months:i,weeks:s,days:n,hours:r,minutes:o,seconds:a,milliseconds:h}=t;return new y(e,i,s,n,r,o,a,h)}throw new RangeError("invalid duration")}static compare(t,e){const i=Date.now(),s=Math.abs(p(i,y.from(t)).getTime()-i),n=Math.abs(p(i,y.from(e)).getTime()-i);return s>n?-1:s<n?1:0}toLocaleString(t,e){return new f(t,e).format(this)}}function p(t,e){const i=new Date(t);return e.sign<0?(i.setUTCSeconds(i.getUTCSeconds()+e.seconds),i.setUTCMinutes(i.getUTCMinutes()+e.minutes),i.setUTCHours(i.getUTCHours()+e.hours),i.setUTCDate(i.getUTCDate()+7*e.weeks+e.days),i.setUTCMonth(i.getUTCMonth()+e.months),i.setUTCFullYear(i.getUTCFullYear()+e.years)):(i.setUTCFullYear(i.getUTCFullYear()+e.years),i.setUTCMonth(i.getUTCMonth()+e.months),i.setUTCDate(i.getUTCDate()+7*e.weeks+e.days),i.setUTCHours(i.getUTCHours()+e.hours),i.setUTCMinutes(i.getUTCMinutes()+e.minutes),i.setUTCSeconds(i.getUTCSeconds()+e.seconds)),i}function b(t,{relativeTo:e=Date.now()}={}){if(e=new Date(e),t.blank)return t;const i=t.sign;let s=Math.abs(t.years),n=Math.abs(t.months),r=Math.abs(t.weeks),o=Math.abs(t.days),a=Math.abs(t.hours),h=Math.abs(t.minutes),u=Math.abs(t.seconds),l=Math.abs(t.milliseconds);l>=900&&(u+=Math.round(l/1e3)),(u||h||a||o||r||n||s)&&(l=0),u>=55&&(h+=Math.round(u/60)),(h||a||o||r||n||s)&&(u=0),h>=55&&(a+=Math.round(h/60)),(a||o||r||n||s)&&(h=0),o&&a>=12&&(o+=Math.round(a/24)),!o&&a>=21&&(o+=Math.round(a/24)),(o||r||n||s)&&(a=0);const c=e.getFullYear(),m=e.getMonth(),d=e.getDate();if(o>=27||s+n+o){const t=new Date(e);t.setDate(1),t.setMonth(m+n*i+1),t.setDate(0);const a=Math.max(0,d-t.getDate()),h=new Date(e);h.setFullYear(c+s*i),h.setDate(d-a),h.setMonth(m+n*i),h.setDate(d-a+o*i);const u=h.getFullYear()-e.getFullYear(),l=h.getMonth()-e.getMonth(),f=Math.abs(Math.round((Number(h)-Number(e))/864e5))+a,g=Math.abs(12*u+l);f<27?(o>=6?(r+=Math.round(o/7),o=0):o=f,n=s=0):g<=11?(n=g,s=0):(n=0,s=u*i),(n||s)&&(o=0)}return s&&(n=0),r>=4&&(n+=Math.round(r/4)),(n||s)&&(r=0),o&&r&&!n&&!s&&(r+=Math.round(o/7),o=0),new y(s*i,n*i,r*i,o*i,a*i,h*i,u*i,l*i)}var v,T,M,D,A,C,E,k,x,U,S,F,I,L,R,N,P=function(t,e,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(t):s?s.value:e.get(t)},Z=function(t,e,i,s,n){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?n.call(t,i):n?n.value=i:e.set(t,i),i};const j=globalThis.HTMLElement||null,O=new y,H=new y(0,0,0,0,0,1);class Y extends Event{constructor(t,e,i,s){super("relative-time-updated",{bubbles:!0,composed:!0}),this.oldText=t,this.newText=e,this.oldTitle=i,this.newTitle=s}}function $(t){if(!t.date)return 1/0;if("duration"===t.format||"elapsed"===t.format){const e=t.precision;if("second"===e)return 1e3;if("minute"===e)return 6e4}const e=Math.abs(Date.now()-t.date.getTime());return e<6e4?1e3:e<36e5?6e4:36e5}const W=new class{constructor(){this.elements=new Set,this.time=1/0,this.timer=-1}observe(t){if(this.elements.has(t))return;this.elements.add(t);const e=t.date;if(e&&e.getTime()){const e=$(t),i=Date.now()+e;i<this.time&&(clearTimeout(this.timer),this.timer=setTimeout(()=>this.update(),e),this.time=i)}}unobserve(t){this.elements.has(t)&&this.elements.delete(t)}update(){if(clearTimeout(this.timer),!this.elements.size)return;let t=1/0;for(const e of this.elements)t=Math.min(t,$(e)),e.update();this.time=Math.min(36e5,t),this.timer=setTimeout(()=>this.update(),this.time),this.time+=Date.now()}};class z extends j{constructor(){super(...arguments),v.add(this),T.set(this,!1),M.set(this,!1),A.set(this,this.shadowRoot?this.shadowRoot:this.attachShadow?this.attachShadow({mode:"open"}):this),N.set(this,null)}static define(t="relative-time",e=customElements){return e.define(t,this),this}get timeZone(){var t;return(null===(t=this.closest("[time-zone]"))||void 0===t?void 0:t.getAttribute("time-zone"))||this.ownerDocument.documentElement.getAttribute("time-zone")||void 0}static get observedAttributes(){return["second","minute","hour","weekday","day","month","year","time-zone-name","prefix","threshold","tense","precision","format","format-style","no-title","datetime","lang","title","aria-hidden","time-zone"]}get onRelativeTimeUpdated(){return P(this,N,"f")}set onRelativeTimeUpdated(t){P(this,N,"f")&&this.removeEventListener("relative-time-updated",P(this,N,"f")),Z(this,N,"object"==typeof t||"function"==typeof t?t:null,"f"),"function"==typeof t&&this.addEventListener("relative-time-updated",t)}get second(){const t=this.getAttribute("second");if("numeric"===t||"2-digit"===t)return t}set second(t){this.setAttribute("second",t||"")}get minute(){const t=this.getAttribute("minute");if("numeric"===t||"2-digit"===t)return t}set minute(t){this.setAttribute("minute",t||"")}get hour(){const t=this.getAttribute("hour");if("numeric"===t||"2-digit"===t)return t}set hour(t){this.setAttribute("hour",t||"")}get weekday(){const t=this.getAttribute("weekday");return"long"===t||"short"===t||"narrow"===t?t:"datetime"===this.format&&""!==t?this.formatStyle:void 0}set weekday(t){this.setAttribute("weekday",t||"")}get day(){var t;const e=null!==(t=this.getAttribute("day"))&&void 0!==t?t:"numeric";if("numeric"===e||"2-digit"===e)return e}set day(t){this.setAttribute("day",t||"")}get month(){const t=this.format;let e=this.getAttribute("month");if(""!==e)return null!=e||(e="datetime"===t?this.formatStyle:"short"),"numeric"===e||"2-digit"===e||"short"===e||"long"===e||"narrow"===e?e:void 0}set month(t){this.setAttribute("month",t||"")}get year(){var t;const e=this.getAttribute("year");return"numeric"===e||"2-digit"===e?e:this.hasAttribute("year")||(new Date).getUTCFullYear()===(null===(t=this.date)||void 0===t?void 0:t.getUTCFullYear())?void 0:"numeric"}set year(t){this.setAttribute("year",t||"")}get timeZoneName(){const t=this.getAttribute("time-zone-name");if("long"===t||"short"===t||"shortOffset"===t||"longOffset"===t||"shortGeneric"===t||"longGeneric"===t)return t}set timeZoneName(t){this.setAttribute("time-zone-name",t||"")}get prefix(){var t;return null!==(t=this.getAttribute("prefix"))&&void 0!==t?t:"datetime"===this.format?"":"on"}set prefix(t){this.setAttribute("prefix",t)}get threshold(){const t=this.getAttribute("threshold");return t&&(e=t,g.test(e))?t:"P30D";var e}set threshold(t){this.setAttribute("threshold",t)}get tense(){const t=this.getAttribute("tense");return"past"===t?"past":"future"===t?"future":"auto"}set tense(t){this.setAttribute("tense",t)}get precision(){const t=this.getAttribute("precision");return w.includes(t)?t:"micro"===this.format?"minute":"second"}set precision(t){this.setAttribute("precision",t)}get format(){const t=this.getAttribute("format");return"datetime"===t?"datetime":"relative"===t?"relative":"duration"===t?"duration":"micro"===t?"micro":"elapsed"===t?"elapsed":"auto"}set format(t){this.setAttribute("format",t)}get formatStyle(){const t=this.getAttribute("format-style");if("long"===t)return"long";if("short"===t)return"short";if("narrow"===t)return"narrow";const e=this.format;return"elapsed"===e||"micro"===e?"narrow":"datetime"===e?"short":"long"}set formatStyle(t){this.setAttribute("format-style",t)}get noTitle(){return this.hasAttribute("no-title")}set noTitle(t){this.toggleAttribute("no-title",t)}get datetime(){return this.getAttribute("datetime")||""}set datetime(t){this.setAttribute("datetime",t)}get date(){const t=Date.parse(this.datetime);return Number.isNaN(t)?null:new Date(t)}set date(t){this.datetime=(null==t?void 0:t.toISOString())||""}connectedCallback(){this.update()}disconnectedCallback(){W.unobserve(this)}attributeChangedCallback(t,e,i){e!==i&&("title"===t&&Z(this,T,null!==i&&(this.date&&P(this,v,"m",C).call(this,this.date))!==i,"f"),P(this,M,"f")||"title"===t&&P(this,T,"f")||Z(this,M,(async()=>{await Promise.resolve(),this.update(),Z(this,M,!1,"f")})(),"f"))}update(){const t=P(this,A,"f").textContent||this.textContent||"",e=this.getAttribute("title")||"";let i=e;const s=this.date;if("undefined"==typeof Intl||!Intl.DateTimeFormat||!s)return void(P(this,A,"f").textContent=t);const n=Date.now();P(this,T,"f")||(i=P(this,v,"m",C).call(this,s)||"",i&&!this.noTitle&&this.setAttribute("title",i));const r=function(t,e="second",i=Date.now()){const s=t.getTime()-i;if(0===s)return new y;const n=Math.sign(s),r=Math.abs(s),o=Math.floor(r/1e3),a=Math.floor(o/60),h=Math.floor(a/60),u=Math.floor(h/24),l=Math.floor(u/30),c=Math.floor(l/12),m=w.indexOf(e)||w.length;return new y(m>=0?c*n:0,m>=1?(l-12*c)*n:0,0,m>=3?(u-30*l)*n:0,m>=4?(h-24*u)*n:0,m>=5?(a-60*h)*n:0,m>=6?(o-60*a)*n:0,m>=7?(r-1e3*o)*n:0)}(s,this.precision,n),o=P(this,v,"m",E).call(this,r);let a=t;const h=P(this,v,"m",R).call(this,o);a=h?P(this,v,"m",I).call(this,s):"duration"===o?P(this,v,"m",k).call(this,r):"relative"===o?P(this,v,"m",x).call(this,r):P(this,v,"m",U).call(this,s),a?P(this,v,"m",L).call(this,a):this.shadowRoot===P(this,A,"f")&&this.textContent&&P(this,v,"m",L).call(this,this.textContent),a===t&&i===e||this.dispatchEvent(new Y(t,a,e,i)),"relative"===o||"duration"===o||h&&(P(this,v,"m",S).call(this,s)||P(this,v,"m",F).call(this,s))?W.observe(this):W.unobserve(this)}}T=new WeakMap,M=new WeakMap,A=new WeakMap,N=new WeakMap,v=new WeakSet,D=function(){var t;const e=(null===(t=this.closest("[lang]"))||void 0===t?void 0:t.getAttribute("lang"))||this.ownerDocument.documentElement.getAttribute("lang");try{return new Intl.Locale(null!=e?e:"").toString()}catch(t){return"default"}},C=function(t){return new Intl.DateTimeFormat(P(this,v,"a",D),{day:"numeric",month:"short",year:"numeric",hour:"numeric",minute:"2-digit",timeZoneName:"short",timeZone:this.timeZone}).format(t)},E=function(t){const e=this.format;if("datetime"===e)return"datetime";if("duration"===e)return"duration";if("elapsed"===e)return"duration";if("micro"===e)return"duration";if(("auto"===e||"relative"===e)&&"undefined"!=typeof Intl&&Intl.RelativeTimeFormat){const e=this.tense;if("past"===e||"future"===e)return"relative";if(1===y.compare(t,this.threshold))return"relative"}return"datetime"},k=function(t){const e=P(this,v,"a",D),i=this.format,s=this.formatStyle,n=this.tense;let r=O;"micro"===i?(t=b(t),r=H,0===t.months&&("past"===this.tense&&-1!==t.sign||"future"===this.tense&&1!==t.sign)&&(t=H)):("past"===n&&-1!==t.sign||"future"===n&&1!==t.sign)&&(t=r);const o=`${this.precision}sDisplay`;return t.blank?r.toLocaleString(e,{style:s,[o]:"always"}):t.abs().toLocaleString(e,{style:s})},x=function(t){const e=new Intl.RelativeTimeFormat(P(this,v,"a",D),{numeric:"auto",style:this.formatStyle}),i=this.tense;"future"===i&&1!==t.sign&&(t=O),"past"===i&&-1!==t.sign&&(t=O);const[s,n]=function(t){const e=b(t,void 0);if(e.blank)return[0,"second"];for(const t of w){if("millisecond"===t)continue;const i=e[`${t}s`];if(i)return[i,t]}return[0,"second"]}(t);return"second"===n&&s<10?e.format(0,"millisecond"===this.precision?"second":this.precision):e.format(s,n)},U=function(t){const e=new Intl.DateTimeFormat(P(this,v,"a",D),{second:this.second,minute:this.minute,hour:this.hour,weekday:this.weekday,day:this.day,month:this.month,year:this.year,timeZoneName:this.timeZoneName,timeZone:this.timeZone});return`${this.prefix} ${e.format(t)}`.trim()},S=function(t){const e=new Date,i=new Intl.DateTimeFormat(P(this,v,"a",D),{timeZone:this.timeZone,year:"numeric",month:"2-digit",day:"2-digit"});return i.format(e)===i.format(t)},F=function(t){const e=new Date,i=new Intl.DateTimeFormat(P(this,v,"a",D),{timeZone:this.timeZone,year:"numeric"});return i.format(e)===i.format(t)},I=function(t){const e={hour:"numeric",minute:"2-digit",timeZoneName:"short",timeZone:this.timeZone};if(P(this,v,"m",S).call(this,t)){let i=new Intl.RelativeTimeFormat(P(this,v,"a",D),{numeric:"auto"}).format(0,"day");return i=i.charAt(0).toLocaleUpperCase(P(this,v,"a",D))+i.slice(1),`${i} ${new Intl.DateTimeFormat(P(this,v,"a",D),e).format(t)}`}const i=Object.assign(Object.assign({},e),{day:"numeric",month:"short"});return P(this,v,"m",F).call(this,t)?new Intl.DateTimeFormat(P(this,v,"a",D),i).format(t):new Intl.DateTimeFormat(P(this,v,"a",D),Object.assign(Object.assign({},i),{year:"numeric"})).format(t)},L=function(t){if(this.hasAttribute("aria-hidden")&&"true"===this.getAttribute("aria-hidden")){const e=document.createElement("span");e.setAttribute("aria-hidden","true"),e.textContent=t,P(this,A,"f").replaceChildren(e)}else P(this,A,"f").textContent=t},R=function(t){var e;return"duration"!==t&&("true"===this.ownerDocument.documentElement.getAttribute("data-prefers-absolute-time")||"true"===(null===(e=this.ownerDocument.body)||void 0===e?void 0:e.getAttribute("data-prefers-absolute-time")))};const G="undefined"!=typeof globalThis?globalThis:window;try{G.RelativeTimeElement=z.define()}catch(t){if(!(G.DOMException&&t instanceof DOMException&&"NotSupportedError"===t.name||t instanceof ReferenceError))throw t}

</script>
</body>
</html>
